\section{Virtual Machine Invocations}\label{sec:virtualmachineinvocations}



\newcommand*{\pvm}{\mathbf{M}}
\newcommand*{\segoff}{\varsigma}

\subsection{Host-Call Result Constants}

\begin{description}
  \item[$\mathtt{NONE} = 2^{64} - 1$] The return value indicating an item does not exist.
  \item[$\mathtt{WHAT} = 2^{64} - 2$] Name unknown.
  \item[$\mathtt{OOB} = 2^{64} - 3$] The return value for when a memory index is provided for reading/writing which is not accessible.
  \item[$\mathtt{WHO} = 2^{64} - 4$] Index unknown.
  \item[$\mathtt{FULL} = 2^{64} - 5$] Storage full.
  \item[$\mathtt{CORE} = 2^{64} - 6$] Core index unknown.
  \item[$\mathtt{CASH} = 2^{64} - 7$] Insufficient funds.
  \item[$\mathtt{LOW} = 2^{64} - 8$] Gas limit too low.
  \item[$\mathtt{HUH} = 2^{64} - 9$] The item is already solicited or cannot be forgotten.
  \item[$\mathtt{OK} = 0$] The return value indicating general success.
\end{description}

Inner \textsc{pvm} invocations have their own set of result codes:
\begin{description}
  \item[$\mathtt{HALT} = 0$] The invocation completed and halted normally.
  \item[$\mathtt{PANIC} = 1$] The invocation completed with a panic.
  \item[$\mathtt{FAULT} = 2$] The invocation completed with a page fault.
  \item[$\mathtt{HOST} = 3$] The invocation completed with a host-call fault.
  \item[$\mathtt{OOG} = 4$] The invocation completed by running out of gas.
\end{description}

Note return codes for a host-call-request exit are any non-zero value less than $2^{64} - 13$.

\subsection{Is-Authorized Invocation}\label{sec:isauthorizedinvocation}

The Is-Authorized invocation is the first and simplest of the four, being totally stateless. It provides only a single host-call function, $\Omega_G$ for determining the amount of gas remaining. It accepts as arguments the work-package as a whole, $\mathbf{p}$ and the core on which it should be executed, $c$. Formally, it is defined as $\Psi_I$:

% TODO: Don't pass in the work-package as a whole - it's probably too big and will cost too much gas. Only pass in the authorization stuff and allow everything else to be fetched using host-calls.

\begin{align}
  \Psi_I &\colon \left\{\begin{aligned}
    (\mathbb{P}, \N_\mathsf{C}) &\to \Y \cup \mathbb{J} \\
    (\mathbf{p}, c) &\mapsto \mathbf{r}\ \where (g, \mathbf{r}, \none) = \Psi_M(\mathbf{p}_\mathbf{c}, 0, \mathsf{G}_I, \mathcal{E}(\mathbf{p}, c), F, \none)
  \end{aligned}\right. \\
  \label{eq:isauthorizedmutator}F \in \Omega\ang{\{\}} &\colon
    (n, \gascounter, \registers, \memory) \mapsto \begin{cases}
      \Omega_G(\gascounter, \registers, \memory) &\when n = \mathtt{gas} \\
      (\continue, \gascounter - 10, [\registers_0, \dots, \registers_6, \mathtt{WHAT}, \registers_8, \dots], \memory) &\otherwise
    \end{cases}
\end{align}
Note for the Is-Authorized host-call dispatch function $F$ in equation \ref{eq:isauthorizedmutator}, we elide the host-call context since, being essentially stateless, it is always $\none$.

\subsection{Refine Invocation}\label{sec:refineinvocation}

We define the Refine service-account invocation function as $\Psi_R$. It has no general access to the state of the \Jam chain, with the slight exception being the ability to make a historical lookup. Beyond this it is able to create inner instances of the \textsc{pvm} and dictate pieces of data to export.

The historical-lookup host-call function, $\Omega_H$, is designed to give the same result regardless of the state of the chain for any time when auditing may occur (which we bound to be less than two epochs from being accumulated). The lookup anchor may be up to $\mathsf{L}$ timeslots before the recent history and therefore adds to the potential age at the time of audit. We therefore set $\mathsf{D} = 4,800$, a safe amount of eight hours.

The inner \textsc{pvm} invocation host-calls, meanwhile, depend on an integrated \textsc{pvm} type, which we shall denote $\pvm$. It holds some program code, instruction counter and \textsc{ram}:
\begin{equation}
  \pvm \equiv \tuple{\isa{\mathbf{p}}{\Y}, \isa{\mathbf{u}}{\ram}, \isa{i}{\N_R}}
\end{equation}

The Export host-call depends on two pieces of context; one sequence of segments (blobs of length $\mathsf{W}_G$) to which it may append, and the other an argument passed to the invocation function to dictate the number of segments prior which may assumed to have already been appended. The latter value ensures that an accurate segment index can be provided to the caller.

Unlike the other invocation functions, the Refine invocation function implicitly draws upon some recent service account state item $\delta$. The specific block from which this comes is not important, as long as it is no earlier than its work-package's lookup-anchor block. It explicitly accepts the work payload, $\mathbf{y}$, together with the service index which is the subject of refinement $s$, the prediction of the hash of that service's code $c$ at the time of reporting, the hash of the containing work-package $p$, the refinement context $\mathbf{c}$, the authorizer hash $a$ and its output $\mathbf{o}$, and an export segment offset $\segoff$, the import segments and extrinsic data blobs as dictated by the work-item, $\mathbf{i}$ and $\overline{\mathbf{x}}$. It results in either some error $\mathbb{J}$ or a pair of the refinement output blob and the export sequence. Formally:
\begin{align}
  &\Psi_R \colon \left\{\begin{aligned}
    \left(\begin{aligned}
      &\H, \N_G, \N_S, \H, \Y, \mathbb{X},\\
      &\H, \Y, \seq{\G}, \seq{\Y}, \N
    \end{aligned}
    \right) &\to (\Y \cup \mathbb{J}, \seq{\Y}) \\
    (c, g, s, p, \mathbf{y}, \mathbf{c}, a, \mathbf{o}, \mathbf{i}, \overline{\mathbf{x}}, \segoff) &\mapsto \begin{cases}
      (\token{BAD}, []) &\when s \not\in \keys{\delta} \vee \Lambda(\delta[s], \mathbf{c}_t, c) = \none \\
      (\token{BIG}, []) &\otherwhen |\Lambda(\delta[s], \mathbf{c}_t, c)| > \mathsf{W}_C \\
      &\otherwise: \\
      &\quad\using a = \se(s, \mathbf{y}, p, \mathbf{c}, a, \var{\mathbf{o}}, \var{\sq{\var{\mathbf{x}} \mid \mathbf{x} \orderedin \overline{\mathbf{x}}}})\ ,\\
      &\quad\also (g, \mathbf{r}, (\mathbf{m}, \mathbf{e})) = \Psi_M(\Lambda(\delta[s], \mathbf{c}_t, c), 0, g, a, F, (\emptyset, []))\ \colon\\
      (\mathbf{r}, []) &\quad\when \mathbf{r} \in \{ \oog, \panic \}  \\
      (\mathbf{r}, \mathbf{e}) &\quad\otherwise \\
    \end{cases} \\
  \end{aligned}\right. \\
  \label{eq:refinemutator}
  &F \in \Omega\ang{(\dict{\N}{\pvm}, \seq{\Y})} \colon
    (n, \gascounter, \registers, \memory, (\mathbf{m}, \mathbf{e})) \mapsto \begin{cases}
      \Omega_H(\gascounter, \registers, \memory, (\mathbf{m}, \mathbf{e}), s, \delta, \mathbf{c}_t) &\when n = \mathtt{historical\_lookup}\\
      \Omega_Y(\gascounter, \registers, \memory, (\mathbf{m}, \mathbf{e}), \mathbf{i}) &\when n = \mathtt{import}\\
      \Omega_E(\gascounter, \registers, \memory, (\mathbf{m}, \mathbf{e}), \segoff) &\when n = \mathtt{export}\\
      \Omega_G(\gascounter, \registers, \memory, (\mathbf{m}, \mathbf{e})) &\when n = \mathtt{gas}\\
      \Omega_M(\gascounter, \registers, \memory, (\mathbf{m}, \mathbf{e})) &\when n = \mathtt{machine}\\
      \Omega_P(\gascounter, \registers, \memory, (\mathbf{m}, \mathbf{e})) &\when n = \mathtt{peek}\\
      \Omega_Z(\gascounter, \registers, \memory, (\mathbf{m}, \mathbf{e})) &\when n = \mathtt{zero}\\
      \Omega_O(\gascounter, \registers, \memory, (\mathbf{m}, \mathbf{e})) &\when n = \mathtt{poke}\\
      \Omega_V(\gascounter, \registers, \memory, (\mathbf{m}, \mathbf{e})) &\when n = \mathtt{void}\\
      \Omega_K(\gascounter, \registers, \memory, (\mathbf{m}, \mathbf{e})) &\when n = \mathtt{invoke}\\
      \Omega_X(\gascounter, \registers, \memory, (\mathbf{m}, \mathbf{e})) &\when n = \mathtt{expunge}\\
      (\continue, \gascounter - 10, \registers', \memory) &\otherwise\\
      \multicolumn{2}{l}{\where \registers' = \registers \exc \registers'_7 = \mathtt{WHAT}}
    \end{cases}
\end{align}

\subsection{Accumulate Invocation}\label{sec:accumulateinvocation}

Since this is a transition which can directly affect a substantial amount of on-chain state, our invocation context is accordingly complex. It is a tuple with elements for each of the aspects of state which can be altered through this invocation and beyond the account of the service itself includes the deferred transfer list and several dictionaries for alterations to preimage lookup state, core assignments, validator key assignments, newly created accounts and alterations to account privilege levels.

Formally, we define our result context to be $\mathbf{X}$, and our invocation context to be a pair of these contexts, $\mathbf{X} \times \mathbf{X}$, with one dimension being the regular dimension and generally named $\mathbf{x}$ and the other being the exceptional dimension and being named $\mathbf{y}$. The only function which actually alters this second dimension is $\mathtt{checkpoint}$, $\Omega_C$ and so it is rarely seen.
\begin{align}
  \mathbf{X} &\equiv \tuple{
    \isa{s}{\N_S},
    \isa{\mathbf{u}}{\partialstate},
    \isa{i}{\N_S},
    \isa{\mathbf{t}}{\seq{\mathbb{T}}},
    \isa{y}{\maybe{\H}}
  }\\
  \forall \mathbf{x} \in \mathbf{X} : \mathbf{x}_\mathbf{s} &\equiv (\mathbf{x}_\mathbf{u})_\mathbf{d}[\mathbf{x}_s]
\end{align}

For all such contexts, we define a convenience equivalence, $\mathbf{x}_\mathbf{s}$, which is the accumulating service account, as found in the dictionary of $(\mathbf{x}_\mathbf{u})_\mathbf{d}$ at the index $\mathbf{x}_s$.

We track both regular and exceptional dimensions within our context mutator, but collapse the result of the invocation to one or the other depending on whether the termination was regular or exceptional (\ie out-of-gas or panic).

We define $\Psi_A$, the Accumulation invocation function as:
\begin{align}
  \Psi_A& \colon\left\{\begin{aligned}
    \tuple{
      \partialstate, \N_T, \N_S, \N_G, \seq{\mathbb{O}}
    }
    &\to
    \tuple{\partialstate, \defxfers, \H\bm{?}, \N_G} \\
    (\mathbf{u}, t, s, g, \mathbf{o}) &\mapsto \begin{cases}
      \tup{I(\mathbf{u}, s)_\mathbf{u}, [], \none, 0} &\when \mathbf{u}_\mathbf{d}[s]_\mathbf{c} = \none \\
      C(\Psi_M(\mathbf{u}_\mathbf{d}[s]_\mathbf{c}, 5, g, \se(t, s, \var{\mathbf{o}}), F, \tup{I(\mathbf{u}, s), I(\mathbf{u}, s)})) &\otherwise
    \end{cases} \\
  \end{aligned}\right.\\
  I&\colon\left\{\begin{aligned}
    (\mathbb{U}, \N_S) &\to \mathbf{X}\\
    (\mathbf{u}, s) &\mapsto \tup{
      s,
      \mathbf{u},
      i,
      \is{\mathbf{t}}{[]},
      \is{y}{\none}
    }\\
    &\qquad\where i = \text{check}((\de_4(\mathcal{H}(\se(s, \eta'_0, \mathbf{H}_t))) \bmod (2^{32}-2^9)) + 2^8) \\
  \end{aligned}\right.\\
  F \in \Omega\ang{(\mathbf{X}, \mathbf{X})} &\colon (n, \gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y})) \mapsto \begin{cases}
    G(\Omega_R(\gascounter, \registers, \memory, \mathbf{s}, \mathbf{x}_s, \mathbf{d}), (\mathbf{x}, \mathbf{y})) &\when n = \mathtt{read} \\
    G(\Omega_W(\gascounter, \registers, \memory, \mathbf{s}, \mathbf{x}_s), (\mathbf{x}, \mathbf{y})) &\when n = \mathtt{write} \\
    G(\Omega_L(\gascounter, \registers, \memory, \mathbf{s}, \mathbf{x}_s, \mathbf{d}), (\mathbf{x}, \mathbf{y})) &\when n = \mathtt{lookup} \\
    \Omega_G(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y})) &\when n = \mathtt{gas} \\
    G(\Omega_I(\gascounter, \registers, \memory, \mathbf{x}_s, \mathbf{d}), (\mathbf{x}, \mathbf{y})) &\when n = \mathtt{info} \\
    \Omega_B(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y})) &\when n = \mathtt{bless}\\
    \Omega_A(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y})) &\when n = \mathtt{assign}\\
    \Omega_D(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y})) &\when n = \mathtt{designate}\\
    \Omega_C(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y})) &\when n = \mathtt{checkpoint} \\
    \Omega_N(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y})) &\when n = \mathtt{new} \\
    \Omega_U(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y})) &\when n = \mathtt{upgrade} \\
    \Omega_T(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y})) &\when n = \mathtt{transfer} \\
    \Omega_J(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y})) &\when n = \mathtt{eject} \\
    \Omega_Q(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y})) &\when n = \mathtt{query} \\
    \Omega_S(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y}), \mathbf{H}_t) &\when n = \mathtt{solicit} \\
    \Omega_F(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y}), \mathbf{H}_t) &\when n = \mathtt{forget} \\
    \Omega_\Taurus(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y})) &\when n = \mathtt{yield} \\
    (\continue, \gascounter - 10, [\registers_0, \dots, \registers_6, \mathtt{WHAT}, \registers_8, \dots], \memory, \mathbf{x}) &\otherwise\\
    \quad \where \mathbf{d} = (\mathbf{x}_\mathbf{u})_\mathbf{d}\;,\ \mathbf{s} = (\mathbf{x}_\mathbf{u})_\mathbf{d}[\mathbf{x}_s]\!\!\!\!\!\!\!\!\!\!\!\!\!\!\!\!\!& \\
  \end{cases} \\
  G&\colon\left\{\begin{aligned}
    ((\{\continue, \halt, \panic, \oog\}, \N_G, \regs, \ram, \mathbb{A}), (\mathbf{X}, \mathbf{X})) &\to (\{\continue, \halt, \panic, \oog\}, \N_G, \regs, \ram, (\mathbf{X}, \mathbf{X})) \\
    ((\varepsilon, \gascounter, \registers, \memory, \mathbf{s}), (\mathbf{x}, \mathbf{y})) &\mapsto (\varepsilon, \gascounter, \registers, \memory, (\mathbf{x}^*, \mathbf{y})) \\
    &\qquad \where \mathbf{x}^* = \mathbf{x} \exc (\mathbf{x}^*_\mathbf{u})_\mathbf{d}[\mathbf{x}^*_s] = \mathbf{s}
  \end{aligned}\right.\\
  C&\colon\left\{\begin{aligned}
    (\N_G, \mathbb{Y} \cup \{\oog, \panic\}, (\mathbf{X}, \mathbf{X})) &\to (\partialstate, \defxfers, \H\bm{?}, \N_G) \\
    (g, \mathbf{o}, (\mathbf{x}, \mathbf{y})) &\mapsto \begin{cases}
      \tup{
        \mathbf{y}_\mathbf{u},
        \mathbf{y}_\mathbf{t},
        \mathbf{y}_y,
        g
      } & \when \mathbf{o} \in \{\oog, \panic\} \\
      \tup{
        \mathbf{x}_\mathbf{u},
        \mathbf{x}_\mathbf{t},
        \mathbf{o},
        g
      } & \otherwhen \mathbf{o} \in \H \\
      \tup{
        \mathbf{x}_\mathbf{u},
        \mathbf{x}_\mathbf{t},
        \mathbf{x}_y,
        g
      } & \otherwise \\
    \end{cases}
  \end{aligned}\right.
\end{align}

The mutator $F$ governs how this context will alter for any given parameterization, and the collapse function $C$ selects one of the two dimensions of context depending on whether the virtual machine's halt was regular or exceptional.

The initializer function $I$ maps some service account $\mathbf{s}$ along with its index $s$ to yield a mutator context such that no alterations to state are implied (beyond those already inherent in $\mathbf{s}$) in either exit scenario. Note that the component $a$ utilizes the random accumulator $\eta_0$ and the block's timeslot $\mathbf{H}_t$ to create a deterministic sequence of identifiers which are extremely likely to be unique.

Concretely, we create the identifier from the Blake2 hash of the identifier of the creating service, the current random accumulator $\eta_0$ and the block's timeslot. Thus, within a service's accumulation it is almost certainly unique, but it is not necessarily unique across all services, nor at all times in the past. We utilize a \emph{check} function to find the first such index in this sequence which does not already represent a service:
\begin{equation}
  \text{check}(i \in \N_S) \equiv \begin{cases}
    i &\when i \not\in \keys{\mathbf{u}_\mathbf{d}} \\
    \text{check}((i - 2^8 + 1) \bmod (2^{32}-2^9) + 2^8)&\otherwise
  \end{cases}
\end{equation}

\nb In the highly unlikely event that a block executes to find that a single service index has inadvertently been attached to two different services, then the block is considered invalid. Since no service can predict the identifier sequence ahead of time, they cannot intentionally disadvantage the block author.

\subsection{On-Transfer Invocation}\label{sec:ontransferinvocation}

We define the On-Transfer service-account invocation function as $\Psi_T$; it is somewhat similar to the Accumulation Invocation except that the only state alteration it facilitates are basic alteration to the storage of the subject account. No further transfers may be made, no privileged operations are possible, no new accounts may be created nor other operations done on the subject account itself. The function is defined as:
\begin{align}
  \Psi_T &: \begin{cases}
    (\dict{\N_S}{\mathbb{A}}, \N_T, \N_S, \seq{\mathbb{T}}) &\to \mathbb{A} \\
    (\mathbf{d}, t, s, \mathbf{t}) &\mapsto \begin{cases}
    \mathbf{s} &\when \mathbf{s}_\mathbf{c} = \none \vee \mathbf{t} = [] \\
    \mathbf{s}' \ \where (g, \mathbf{r}, \mathbf{s}') =\Psi_M(\mathbf{s}_\mathbf{c}, 10, \sum_{r \in \mathbf{t}}{(r_g)}, \se(t, s, \var{\mathbf{t}}), F, \mathbf{s}) &\otherwise
    \end{cases} \\
  \end{cases} \\
  \where \mathbf{s} &= \mathbf{d}[s]\exc\mathbf{s}_b = \mathbf{d}[s]_b + \sum_{r \in \mathbf{t}}{r_a} \\
  F \in \Omega\ang{\mathbb{A}}\colon (n, \gascounter, \registers, \memory, \mathbf{s}) &\equiv \begin{cases}
    \Omega_L(\gascounter, \registers, \memory, \mathbf{s}, s, \mathbf{d}) &\when n = \mathtt{lookup} \\
    \Omega_R(\gascounter, \registers, \memory, \mathbf{s}, s, \mathbf{d}) &\when n = \mathtt{read} \\
    \Omega_W(\gascounter, \registers, \memory, \mathbf{s}, s) &\when n = \mathtt{write} \\
    \Omega_G(\gascounter, \registers, \memory) &\when n = \mathtt{gas} \\
    \Omega_I(\gascounter, \registers, \memory, s, \mathbf{d}) &\when n = \mathtt{info} \\
    (\continue, \gascounter - 10, [\registers_0, \dots, \registers_6, \mathtt{WHAT}, \registers_8, \dots], \memory, \mathbf{s}) &\otherwise
  \end{cases}
\end{align}







\subsection{General Functions}\label{sec:generalfunctions}

We come now to defining the host functions which are utilized by the \textsc{pvm} invocations. Generally, these map some \textsc{pvm} state, including invocation context, possibly together with some additional parameters, to a new \textsc{pvm} state.

The general functions are all broadly of the form $(\gascounter' \in \Z_G, \registers' \in \regs, \memory', \mathbf{s}') = \Omega_\square(\gascounter \in \N_G, \registers \in \regs, \memory \in \ram, \mathbf{s} \in \mathbb{A}, \dots)$. Functions which have a result component which is equivalent to the corresponding argument may have said components elided in the description. Functions may also depend upon particular additional parameters.

Unlike the Accumulate functions in appendix \ref{sec:accumulatefunctions}, these do not mutate an accumulation context, but merely a service account $\mathbf{s}$.

The $\mathtt{gas}$ function, $\Omega_G$ has a parameter list suffixed with an ellipsis to denote that any additional parameters may be taken and are provided transparently into its result. This allows it to be easily utilized in multiple \textsc{pvm} invocations.

Other than the gas-counter which is explicitly defined, elements of \textsc{pvm} state are each assumed to remain unchanged by the host-call unless explicitly specified.
\begin{align}
  \gascounter' &\equiv \gascounter - g\\
  (\varepsilon', \registers', \memory', \mathbf{s}') &\equiv \begin{cases}
    (\oog, \registers, \memory, \mathbf{s}) &\when \gascounter < g\\
    (\continue, \registers, \memory, \mathbf{s}) \text{ except as indicated below} &\otherwise
  \end{cases}
\end{align}

\aboverulesep = 1.5mm \belowrulesep = 2mm

\begin{longtable}{p{3.5cm} p{12.5cm}}
  \toprule
  \thead*{\textbf{Function} \\ \textbf{Identifier} \\ \textbf{Gas usage}} &
  \thead{\textbf{Mutations}} \\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \endhead
  \makecell*[l]{
  $\Omega_G(\gascounter, \registers, \dots)$ \\
  \texttt{gas} = 0 \\
  $g = 10$} &
  $\begin{aligned}
    \registers'_7 &\equiv \gascounter'
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_L(\gascounter, \registers, \memory, \mathbf{s}, s, \mathbf{d})$ \\
  \texttt{lookup} = 1 \\
  $g = 10$} &
  $\begin{aligned}
    \using \mathbf{a} &= \begin{cases} \mathbf{s} &\when \registers_7 \in \{ s, 2^{64} - 1 \} \\ \mathbf{d}[\registers_7] &\otherwise \end{cases} \\
    \using [h_o, b_o, b_z] &= \registers_{8..11} \\
    \using h &= \begin{cases}
      \mathcal{H}(\memory_{h_o\dots+32}) &\when \mathbb{Z}_{h_o \dots+ 32} \subset \mathbb{V}_{\memory} \\
      \error &\otherwise
    \end{cases} \\
    \using \mathbf{v} &= \begin{cases}
      \mathbf{a}_\mathbf{p}[h] &\when \mathbf{a} \ne \none \wedge h \in \keys{\mathbf{a}_\mathbf{p}} \\
      \none &\otherwise
    \end{cases} \\
    \forall i \in \N_{\min(b_z, |\mathbf{v}|)} : \memory'_{b_o + i} &\equiv \begin{cases}
      \mathbf{v}_i & \when \mathbf{v} \ne \none \wedge \mathbb{Z}_{b_o \dots+ b_z} \subset \mathbb{V}^*_{\memory} \\
      \memory_{b_o + i} & \otherwise
    \end{cases} \\
    \registers'_7 &\equiv \begin{cases}
      \begin{rcases}
        \mathtt{NONE} & \when \mathbf{v} = \none \\
        |\mathbf{v}| &\otherwise \\
      \end{rcases} &\when h \ne \error \wedge \mathbb{Z}_{b_o \dots+ b_z} \subset \mathbb{V}^*_{\memory} \\
      \mathtt{OOB} &\otherwise
    \end{cases}
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_R(\gascounter, \registers, \memory, \mathbf{s}, s, \mathbf{d})$ \\
  \texttt{read} = 2 \\
  $g = 10$} &
  % gas cost for cold reads dependent on trie depth.
  $\begin{aligned}
    \using \mathbf{a} &= \begin{cases}
      \mathbf{s} &\when \registers_7 \in \{ s, 2^{64} - 1 \} \\
      \mathbf{d}[\registers_7] &\otherwhen \registers_7 \in \keys{\mathbf{d}} \\
      \none &\otherwise
    \end{cases} \\
    \using [k_o, k_z, b_o, b_z] &= \registers_{8..12} \\
    \using k &= \begin{cases}
      \mathcal{H}(\se_4(s) \concat \memory_{k_o\dots+k_z}) &\when \mathbb{Z}_{k_o \dots+ k_z} \subset \mathbb{V}_{\memory} \\
      \error &\otherwise
    \end{cases} \\
    \using \mathbf{v} &= \begin{cases}
      \mathbf{a}_\mathbf{s}[k] &\when \mathbf{a} \ne \none \wedge k \in \keys{\mathbf{a}_\mathbf{s}} \\
      \none &\otherwise
    \end{cases} \\
    \forall i \in \N_{\min(b_z, |\mathbf{v}|)} : \memory'_{b_o + i} &\equiv \begin{cases}
      \mathbf{v}_i & \when \mathbf{v} \ne \none \wedge \mathbb{Z}_{b_o \dots+ b_z} \subset \mathbb{V}^*_{\memory} \\
      \memory_{b_o + i} & \otherwise
    \end{cases} \\
    \registers'_7 &\equiv \begin{cases}
      \begin{rcases}
        \mathtt{NONE} & \when \mathbf{v} = \none \\
        |\mathbf{v}| &\otherwise \\
      \end{rcases} &\when k \ne \error \wedge \mathbb{Z}_{b_o \dots+ b_z} \subset \mathbb{V}^*_{\memory} \\
      \mathtt{OOB} &\otherwise
    \end{cases}
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_W(\gascounter, \registers, \memory, \mathbf{s}, s)$ \\
  \texttt{write} = 3 \\
  $g = 10$
  } &
  $\begin{aligned}
    \using [k_o, k_z, v_o, v_z] &= \registers_{7..11} \\
    \using k &= \begin{cases}
      \mathcal{H}(\se_4(s) \concat \memory_{k_o\dots+k_z}) &\when \mathbb{Z}_{k_o \dots+ k_z} \subset \mathbb{V}_{\memory} \\
      \error &\otherwise
    \end{cases} \\
    \using \mathbf{a} &= \begin{cases}
      \mathbf{s} \exc \begin{rcases}
        \keys{\mathbf{a}_\mathbf{s}} = \keys{\mathbf{a}_\mathbf{s}} \setminus \{k\} & \when v_z = 0 \\
        \mathbf{a}_\mathbf{s}[k] = \memory_{v_o\dots+v_z} &\otherwise \\
      \end{rcases} &\when \mathbb{Z}_{v_o \dots+ v_z} \subset \mathbb{V}_{\memory} \\
      \error &\otherwise
    \end{cases} \\
    \using l &= \begin{cases}
      |\mathbf{s}_\mathbf{s}[k]| &\when k \in \keys{\mathbf{s}_\mathbf{s}} \\
      \mathtt{NONE} &\otherwise
    \end{cases} \\
    (\registers'_7, \mathbf{s}') &\equiv \begin{cases}
      (l, \mathbf{a}) &\when k \ne \error \wedge \mathbf{a} \ne \error \wedge \mathbf{a}_t \le \mathbf{a}_b\\
      (\mathtt{FULL}, \mathbf{s}) &\when \mathbf{a}_t > \mathbf{a}_b \\
      (\mathtt{OOB}, \mathbf{s}) &\otherwise
    \end{cases}
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_I(\gascounter, \registers, \memory, s, \mathbf{d})$ \\
  \texttt{info} = 4 \\
  $g = 10$} &
  $\begin{aligned}
    \using \mathbf{t} &= \begin{cases}
      \mathbf{d}[s] &\when \registers_7 = 2^{64} - 1 \\
      \mathbf{d}[\registers_7] &\otherwise
    \end{cases} \\
    \using o &= \registers_8 \\
    \using \mathbf{m} &= \begin{cases}
      \mathcal{E}(\mathbf{t}_c, \mathbf{t}_b, \mathbf{t}_t, \mathbf{t}_g, \mathbf{t}_m, \mathbf{t}_l, \mathbf{t}_i) &\when \mathbf{t} \ne \none \\
      \none &\otherwise
    \end{cases} \\
    \forall i \in \N_{|\mathbf{m}|} : \memory'_{o + i} &\equiv \begin{cases}
      \mathbf{m}_i & \when \mathbf{m} \ne \none \wedge \mathbb{Z}_{o \dots+ |\mathbf{m}|} \subset \mathbb{V}^*_{\memory} \\
      \memory_{o + i} & \otherwise
    \end{cases} \\
    \registers'_7 &\equiv \begin{cases}
      \mathtt{OK} & \when \mathbf{m} \ne \none \wedge \mathbb{Z}_{o \dots+ |\mathbf{m}|} \subset \mathbb{V}^*_{\memory} \\
      \mathtt{NONE} & \when \mathbf{m} = \none \\
      \mathtt{OOB} & \otherwise \\
    \end{cases}
  \end{aligned}$ \\
  \bottomrule
\end{longtable}

\subsection{Accumulate Functions}\label{sec:accumulatefunctions}

This defines a number of functions broadly of the form $(\gascounter' \in \Z_G, \registers' \in \regs, \memory', (\mathbf{x}', \mathbf{y}')) = \Omega_\square(\gascounter \in \N_G, \registers \in \regs, \memory \in \ram, (\mathbf{x}\in \mathbf{X}, \mathbf{y}\in \mathbf{X}), \dots)$. Functions which have a result component which is equivalent to the corresponding argument may have said components elided in the description. Functions may also depend upon particular additional parameters.

Other than the gas-counter which is explicitly defined, elements of \textsc{pvm} state are each assumed to remain unchanged by the host-call unless explicitly specified.
\begin{align}
  \gascounter' &\equiv \gascounter - g\\
  (\varepsilon', \registers', \memory', \mathbf{x}', \mathbf{y}') &\equiv \begin{cases}
    (\oog, \registers, \memory, \mathbf{x}, \mathbf{y}) &\when \gascounter < g\\
    (\continue, \registers, \memory, \mathbf{x}, \mathbf{y}) \text{ except as indicated below} &\otherwise
  \end{cases}
\end{align}

\begin{longtable}{p{3.5cm} p{12.5cm}}
  \toprule
  \thead*{\textbf{Function} \\ \textbf{Identifier} \\ \textbf{Gas usage}} &
  \thead{\textbf{Mutations}} \\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \endhead
  \makecell*[l]{
  $\Omega_B(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y}))$ \\
  \texttt{bless} = 5 \\
  $g = 10$}&
  $\begin{aligned}
    \using [m, a, v, o, n] &= \registers_{7 \dots 12} \\
    \using \mathbf{g} &= \begin{cases}
      \left\{ (s \mapsto g) \ \where \se_4(s) \concat \se_8(g) = \memory_{o+12i\dots+12} \mid i \in \N_n \right\} &\when \mathbb{Z}_{o \dots+ 12n} \subset \mathbb{V}_{\memory} \\
      \error &\otherwise
    \end{cases} \\
    (\registers'_7, (\mathbf{x}'_\mathbf{u})_\mathbf{x}) &= \begin{cases}
      (\mathtt{OOB}, (\mathbf{x}_\mathbf{u})_\mathbf{x}) &\when \mathbf{g} = \error\\
      (\mathtt{WHO}, (\mathbf{x}_\mathbf{u})_\mathbf{x}) &\otherwhen (m, a, v) \not\in (\N_S, \N_S, \N_S) \\
      (\mathtt{OK}, \tuple{m, a, v, \mathbf{g}}) &\otherwise \\
    \end{cases}
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_A(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y}))$ \\
  \texttt{assign} = 6 \\
  $g = 10$} &
  $\begin{aligned}
    \using o &= \registers_8 \\
    \using \mathbf{c} &= \begin{cases}
      \left[\memory_{o + 32i \dots+ 32} \mid i \orderedin \N_\mathsf{Q}\right] &\when \mathbb{Z}_{o \dots+ 32\mathsf{Q}} \subset \mathbb{V}_{\memory} \\
      \error &\otherwise
    \end{cases} \\
    (\registers'_7, (\mathbf{x}'_\mathbf{u})_\mathbf{q}[\registers_7]) &= \begin{cases}
      (\mathtt{OOB}, (\mathbf{x}_\mathbf{u})_\mathbf{q}[\registers_7]) &\when \mathbf{c} = \error \\
      (\mathtt{CORE}, (\mathbf{x}_\mathbf{u})_\mathbf{q}[\registers_7]) &\otherwhen \registers_7 \ge \mathsf{C} \\
      (\mathtt{OK}, \mathbf{c}) &\otherwise \\
    \end{cases} \\
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_D(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y}))$ \\
  \texttt{designate} = 7 \\
  $g = 10$} &
  $\begin{aligned}
    \using o &= \registers_7 \\
    \using \mathbf{v} &= \begin{cases}
      \left[\memory_{o + 336i \dots+ 336} \mid i \orderedin \N_\mathsf{V}\right] &\when \mathbb{Z}_{o \dots+ 336\mathsf{V}} \subset \mathbb{V}_{\memory} \\
      \error &\otherwise
    \end{cases} \\
    (\registers'_7, (\mathbf{x}'_\mathbf{u})_\mathbf{i}) &= \begin{cases}
      (\mathtt{OOB}, (\mathbf{x}_\mathbf{u})_\mathbf{i}) &\when \mathbf{v} = \error\\
      (\mathtt{OK}, \mathbf{v}) &\otherwise \\
    \end{cases} \\
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_C(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y}))$ \\
  \texttt{checkpoint} = 8 \\
  $g = 10$} &
  $\begin{aligned}
    \mathbf{y'} &\equiv \mathbf{x} \\
    \registers'_7 &\equiv \gascounter'
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_N(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y}))$ \\
  \texttt{new} = 9 \\
  $g = 10$} &
  $\begin{aligned}
    \using [o, l, g&, m] = \registers_{7..11} \\
    \using c &= \begin{cases}
      \memory_{o\dots+32} &\when \N_{o\dots+32} \subset \mathbb{V}_{\memory} \\
      \error &\otherwise
    \end{cases}\\
    \using \mathbf{a} \in \mathbb{A} \cup \{\error\} &= \begin{cases}
      \tup{c, \is{\mathbf{s}}{\{\}}, \is{\mathbf{l}}{\{ (c, l) \mapsto [] \}}, \is{b}{\mathbf{a}_t}, g, m} &\when c \ne \error\\
      \error &\otherwise
    \end{cases} \\
    \using \mathbf{s} &= \mathbf{x}_\mathbf{s} \exc \mathbf{s}_b = (\mathbf{x}_\mathbf{s})_b - \mathbf{a}_t \\
    (\registers'_7, \mathbf{x}'_i, (\mathbf{x}'_\mathbf{u})_\mathbf{d}) &\equiv \begin{cases}
      (\mathbf{x}_i, \text{check}(\text{bump}(\mathbf{x}_i)), (\mathbf{x}_\mathbf{u})_\mathbf{d} \cup \{ \mathbf{x}_i \mapsto \mathbf{a}, \mathbf{x}_s \mapsto \mathbf{s} \}) &\when \mathbf{a} \ne \error \wedge \mathbf{s}_b \ge (\mathbf{x}_\mathbf{s})_t \\
      \multicolumn{2}{l}{\quad \where \text{bump}(i \in \N_S) = 2^8 + (i - 2^8 + 42) \bmod (2^{32} - 2^9)}\\
      (\mathtt{OOB}, \mathbf{x}_i, (\mathbf{x}_\mathbf{u})_\mathbf{d}) &\when c = \error \\
      (\mathtt{CASH}, \mathbf{x}_i, (\mathbf{x}_\mathbf{u})_\mathbf{d}) &\otherwise
    \end{cases} \\
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
    $\Omega_U(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y}))$ \\
    \texttt{upgrade} = 10 \\
    $g = 10$
  } &
  $\begin{aligned}
    \using [o, g, m] &= \registers_{7..10} \\
    \using c &= \begin{cases}
      \memory_{o\dots+32} &\when \N_{o \dots+ 32} \subset \mathbb{V}_{\memory} \\
      \error &\otherwise
    \end{cases} \\
    (\registers'_7, (\mathbf{x}'_\mathbf{s})_c, (\mathbf{x}'_\mathbf{s})_g, (\mathbf{x}'_\mathbf{s})_m) &\equiv \begin{cases}
      (\mathtt{OK}, c, g, m) &\when c \ne \error\\
      (\mathtt{OOB}, (\mathbf{x}_\mathbf{s})_c, (\mathbf{x}_\mathbf{s})_g, (\mathbf{x}_\mathbf{s})_m) &\otherwise
    \end{cases}
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_T(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y}))$ \\
  \texttt{transfer} = 11 \\
  $g = 10 + \registers_9 $} &
  $\begin{aligned}
    \using [d, a, l, o] &= \registers_{7..11},  \\
    \using \mathbf{d} &= (\mathbf{x}_\mathbf{u})_\mathbf{d}\\
    \using \mathbf{t} \in \mathbb{T} \cup \{\error\} &= \begin{cases}
      \tup{\is{s}{\mathbf{x}_s}, d, a, \is{m}{\memory_{o\dots+\mathsf{W}_T}}, \is{g}{l}} &\when \N_{o\dots+\mathsf{W}_T} \subset \mathbb{V}_{\memory} \\
      \error &\otherwise
    \end{cases} \\
    \using b &= (\mathbf{x}_\mathbf{s})_b - a \\
    (\registers'_7, \mathbf{x}'_\mathbf{t}, (\mathbf{x}'_\mathbf{s})_b) &\equiv \begin{cases}
      (\mathtt{OOB}, \mathbf{x}_\mathbf{t}, (\mathbf{x}_\mathbf{s})_b) &\when \mathbf{t} = \error \\
      (\mathtt{WHO}, \mathbf{x}_\mathbf{t}, (\mathbf{x}_\mathbf{s})_b) &\otherwhen d \not \in \keys{\mathbf{d}} \\
      (\mathtt{LOW}, \mathbf{x}_\mathbf{t}, (\mathbf{x}_\mathbf{s})_b) &\otherwhen l < \mathbf{d}[d]_m \\
      (\mathtt{CASH}, \mathbf{x}_\mathbf{t}, (\mathbf{x}_\mathbf{s})_b) &\otherwhen b < (\mathbf{x}_\mathbf{s})_t \\
      (\mathtt{OK}, \mathbf{x}_\mathbf{t} \doubleplus \mathbf{t}, b) &\otherwise
    \end{cases} \\
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_J(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y}), t)$ \\
  \texttt{eject} = 12 \\
  $g = 10$} &
  $\begin{aligned}
    \using [d, o] &= \registers_{7,8} \\
    \using h &= \begin{cases}
      \memory_{o\dots+32} &\when \mathbb{Z}_{o \dots+ 32} \subset \mathbb{V}_{\memory} \\
      \error &\otherwise
    \end{cases} \\
    \using \mathbf{d} &= \begin{cases}
      ((\mathbf{x}_\mathbf{u})_\mathbf{d})[d] &\when d \ne \mathbf{x}_s \wedge d \in \keys{(\mathbf{x}_\mathbf{u})_\mathbf{d}} \\
      \error &\otherwise \\
    \end{cases} \\
    \using l &= \max(81, \mathbf{d}_o) - 81 \\
    \using \mathbf{s}' &= ((\mathbf{x}_\mathbf{u})_\mathbf{d})[\mathbf{x}_s] \exc \mathbf{s}'_b = ((\mathbf{x}_\mathbf{u})_\mathbf{d})[\mathbf{x}_s]_b + \mathbf{d}_b \\
    (\registers'_7, (\mathbf{x}'_\mathbf{u})_\mathbf{d}) &\equiv \begin{cases}
      (\mathtt{OOB}, (\mathbf{x}_\mathbf{u})_\mathbf{d}) &\when h = \error \\
      (\mathtt{WHO}, (\mathbf{x}_\mathbf{u})_\mathbf{d}) &\otherwhen \mathbf{d} = \error \vee \mathbf{d}_c \ne \se_{32}(\mathbf{x}_s) \\
      (\mathtt{HUH}, (\mathbf{x}_\mathbf{u})_\mathbf{d}) &\otherwhen \mathbf{d}_i \ne 2 \vee (h, l) \not\in \mathbf{d}_\mathbf{l} \\
      (\mathtt{OK}, (\mathbf{x}_\mathbf{u})_\mathbf{d} \setminus \{d\} \cup \{ \mathbf{x}_s \mapsto \mathbf{s}' \}) &\otherwhen \mathbf{d}_\mathbf{l}[h, l] = [x, y], y < t - \mathsf{D} \\
      (\mathtt{HUH}, (\mathbf{x}_\mathbf{u})_\mathbf{d}) &\otherwise \\
    \end{cases} \\
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_Q(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y}))$ \\
  \texttt{query} = 13 \\
  $g = 10$} &
  $\begin{aligned}
    \using [o, z] &= \registers_{7, 8} \\
    \using h &= \begin{cases}
      \memory_{o\dots+32} &\when \mathbb{Z}_{o \dots+ 32} \subset \mathbb{V}_{\memory} \\
      \error &\otherwise
    \end{cases} \\
    \using \mathbf{a} &= \begin{cases}
      (\mathbf{x}_\mathbf{s})_\mathbf{l}[h, z] &\when (h, z) \in \keys{(\mathbf{x}_\mathbf{s})_\mathbf{l}}\\
      \error &\otherwise\\
    \end{cases} \\
    (\registers'_7, \registers'_8) &\equiv \begin{cases}
      (\mathtt{OOB}, \registers_8) &\when h = \error \\
      (\mathtt{NONE}, 0) &\otherwhen \mathbf{a} = \error \\
      (0, 0) &\otherwhen \mathbf{a} = [] \\
      (1 + 2^{32}x, 0) &\otherwhen \mathbf{a} = [x] \\
      (2 + 2^{32}x, y) &\otherwhen \mathbf{a} = [x, y] \\
      (3 + 2^{32}x, y + 2^{32}z) &\otherwhen \mathbf{a} = [x, y, z] \\
    \end{cases} \\
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_S(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y}), t)$ \\
  \texttt{solicit} = 14 \\
  $g = 10$} &
  $\begin{aligned}
    \using [o, z] &= \registers_{7, 8} \\
    \using h &= \begin{cases}
      \memory_{o\dots+32} &\when \mathbb{Z}_{o \dots+ 32} \subset \mathbb{V}_{\memory} \\
      \error &\otherwise
    \end{cases} \\
    \using \mathbf{a} &= \begin{cases}
      \mathbf{x}_\mathbf{s} \text{ except: } &\\
      \quad \mathbf{a}_\mathbf{l}[\tup{h, z}] = [] &\when h \ne \error \wedge (h, z) \not\in (\mathbf{x}_\mathbf{s})_\mathbf{l} \\
      \quad \mathbf{a}_\mathbf{l}[\tup{h, z}] = (\mathbf{x}_\mathbf{s})_\mathbf{l}[\tup{h, z}] \doubleplus t &\when (\mathbf{x}_\mathbf{s})_\mathbf{l}[\tup{h, z}] = [x, y] \\
      \error &\otherwise\\
    \end{cases} \\
    (\registers'_7, \mathbf{x}'_\mathbf{s}) &\equiv \begin{cases}
      (\mathtt{OOB}, \mathbf{x}_\mathbf{s}) &\when h = \error \\
      (\mathtt{HUH}, \mathbf{x}_\mathbf{s}) &\otherwhen \mathbf{a} = \error \\
      (\mathtt{FULL}, \mathbf{x}_\mathbf{s}) &\otherwhen \mathbf{a}_b < \mathbf{a}_t \\
      (\mathtt{OK}, \mathbf{a}) &\otherwise \\
    \end{cases} \\
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_F(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y}), t)$ \\
  \texttt{forget} = 15 \\
  $g = 10$} &
  $\begin{aligned}
    \using [o, z] &= \registers_{7, 8} \\
    \using h &= \begin{cases}
      \memory_{o\dots+32} &\when \mathbb{Z}_{o \dots+ 32} \subset \mathbb{V}_{\memory} \\
      \error &\otherwise
    \end{cases} \\
    \using \mathbf{a} &= \begin{cases}
      \mathbf{x}_\mathbf{s} \text{ except:} &\\
      \quad \left.
        \begin{aligned}
          \keys{\mathbf{a}_\mathbf{l}} &= \keys{(\mathbf{x}_\mathbf{s})_\mathbf{l}} \setminus \{\tup{h, z}\}\ ,\\[2pt]
          \keys{\mathbf{a}_\mathbf{p}} &= \keys{(\mathbf{x}_\mathbf{s})_\mathbf{p}} \setminus \{h\}
        \end{aligned}
      \ \right\} &\when (\mathbf{x}_\mathbf{s})_\mathbf{l}[h, z] \in \{[], [x, y]\},\ y < t - \mathsf{D} \\
      \quad \mathbf{a}_\mathbf{l}[h, z] = [x, t] &\when (\mathbf{x}_\mathbf{s})_\mathbf{l}[h, z] = [x] \\
      \quad \mathbf{a}_\mathbf{l}[h, z] = [w, t] &\when (\mathbf{x}_\mathbf{s})_\mathbf{l}[h, z] = [x, y, w],\ y < t - \mathsf{D} \\
      \error &\otherwise\\
    \end{cases} \\
    (\registers'_7, \mathbf{x}'_\mathbf{s}) &\equiv \begin{cases}
      (\mathtt{OOB}, \mathbf{x}_\mathbf{s}) &\when h = \error \\
      (\mathtt{HUH}, \mathbf{x}_\mathbf{s}) &\otherwhen \mathbf{a} = \error \\
      (\mathtt{OK}, \mathbf{a}) &\otherwise \\
    \end{cases} \\
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_\Aries(\gascounter, \registers, \memory, (\mathbf{x}, \mathbf{y}))$ \\
  \texttt{yield} = 16 \\
  $g = 10$} &
  $\begin{aligned}
    \using o &= \registers_7 \\
    \using h &= \begin{cases}
      \memory_{o\dots+32} &\when \mathbb{Z}_{o \dots+ 32} \subset \mathbb{V}_{\memory} \\
      \error &\otherwise
    \end{cases} \\
    (\registers'_7, \mathbf{x}'_y) &\equiv \begin{cases}
      (\mathtt{OOB}, \mathbf{x}_y) &\when h = \error \\
      (\mathtt{OK}, h) &\otherwise \\
    \end{cases} \\
  \end{aligned}$\\
  \bottomrule
\end{longtable}

\subsection{Refine Functions}\label{sec:refinefunctions}

These assume some refine context pair $(\mathbf{m}, \mathbf{e}) \in (\dict{\N}{\pvm}, \seq{\mathbb{G}})$, which are both initially empty. Other than the gas-counter which is explicitly defined, elements of \textsc{pvm} state are each assumed to remain unchanged by the host-call unless explicitly specified.
\begin{align}
  \gascounter' &\equiv \gascounter - g\\
  (\varepsilon', \registers', \memory') &\equiv \begin{cases}
    (\oog, \registers, \memory) &\when \gascounter < g\\
    (\continue, \registers, \memory) \text{ except as indicated below} &\otherwise
  \end{cases}
\end{align}

\begin{longtable}{p{3.5cm} p{12.5cm}}
  \toprule
  \thead*{\textbf{Function} \\ \textbf{Identifier} \\ \textbf{Gas usage}} &
  \thead{\textbf{Mutations}} \\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \endhead
  \makecell*[l]{
  $\Omega_H(\gascounter, \registers, \memory, (\mathbf{m}, \mathbf{e}), s, \mathbf{d}, t)$ \\
  \texttt{historical\_lookup} = 17 \\
  $g = 10$} &
  $\begin{aligned}
    \using \mathbf{a} &= \begin{cases}
      \mathbf{d}[s] &\when \registers_7 = 2^{64} - 1 \wedge s \in \keys{\mathbf{d}} \\
      \mathbf{d}[\registers_7] &\when \registers_7 \in \keys{\mathbf{d}} \\
      \none &\otherwise
    \end{cases} \\
    \using [h_o, b_o, b_z] &= \registers_{8..11} \\
    \using h &= \begin{cases}
      \mathcal{H}(\memory_{h_o\dots+32}) &\when \mathbb{Z}_{h_o \dots+ 32} \subset \mathbb{V}_{\memory} \\
      \error &\otherwise
    \end{cases} \\
    \using \mathbf{v} &= \Lambda(\mathbf{a}, t, h) \\
    \forall i \in \N_{\min(b_z, |\mathbf{v}|)} : \memory'_{b_o + i} &\equiv \begin{cases}
      \mathbf{v}_i & \when \mathbf{v} \ne \none \wedge \mathbb{Z}_{b_o \dots+ b_z} \subset \mathbb{V}^*_{\memory} \\
      \memory_{b_o + i} & \otherwise
    \end{cases} \\
    \registers'_7 &\equiv \begin{cases}
      \mathtt{OOB} &\when h = \error \vee \mathbb{Z}_{b_o \dots+ b_z} \not\subset \mathbb{V}^*_{\memory} \\
      \mathtt{NONE} &\otherwhen \mathbf{v} = \none \\
      |\mathbf{v}| &\otherwise \\
    \end{cases}
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_Y(\gascounter, \registers, \memory, (\mathbf{m}, \mathbf{e}), \mathbf{i})$ \\
  \texttt{import} = 18 \\
  $g = 10$} &
  $\begin{aligned}
    \using \mathbf{v} &= \begin{cases}
      \mathbf{i}_{\registers_7} &\when \registers_7 < |\mathbf{i}| \\
      \none &\otherwise
    \end{cases} \\
    \using o &= \registers_8 \\
    \using l &= \min(\registers_9, \mathsf{W}_G) \\
    \memory'_{o\dots+l} &\equiv \begin{cases}
      \mathbf{v} & \when \mathbf{v} \ne \none \wedge \mathbb{N}_{o \dots+ l} \subset \mathbb{V}^*_{\memory} \\
      \memory_{o\dots+l} & \otherwise
    \end{cases} \\
    \registers'_7 &\equiv \begin{cases}
      \mathtt{OOB} &\when \mathbb{Z}_{o \dots+ l} \not\subset \mathbb{V}^*_{\memory} \\
      \mathtt{NONE} & \otherwhen \mathbf{v} = \none \\
      \mathtt{OK} &\otherwise \\
    \end{cases}
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_E(\gascounter, \registers, \memory, (\mathbf{m}, \mathbf{e}), \segoff)$ \\
  \texttt{export} = 19 \\
  $g = 10$} &
  $\begin{aligned}
    \using p &= \registers_7 \\
    \using z &= \min(\registers_8, \mathsf{W}_G) \\
    \using \mathbf{x} &= \begin{cases}
      \mathcal{P}_{\mathsf{W}_G}(\memr_{p\dots+z}) &\when \N_{p\dots+z} \subseteq \mathbb{V}_\memory\\
      \error &\otherwise
    \end{cases}\\
    (\registers'_7, \mathbf{e}') &\equiv \begin{cases}
      (\mathtt{OOB}, \mathbf{e}) &\when \mathbf{x} = \error \\
      (\mathtt{FULL}, \mathbf{e}) &\otherwhen \segoff+|\mathbf{e}| \ge \mathsf{W}_M \\
      (\segoff + |\mathbf{e}|, \mathbf{e} \doubleplus \mathbf{x}) &\otherwise
    \end{cases}
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_M(\gascounter, \registers, \memory, (\mathbf{m}, \mathbf{e}))$ \\
  \texttt{machine} = 20 \\
  $g = 10$} &
  $\begin{aligned}
    \using [p_o, p_z, i] &= \registers_{7 \dots 10} \\
    \using \mathbf{p} &= \begin{cases}
      \memory_{p_o\dots+p_z} &\when \mathbb{Z}_{p_o \dots+ p_z} \subset \mathbb{V}_{\memory} \\
      \error &\otherwise
    \end{cases} \\
    \using n &= \min(n \in \N, n \not\in \keys{\mathbf{m}}) \\
    \using \mathbf{u} &= \tup{\is{\mathbf{V}}{[0, 0, \dots]},\is{\mathbf{A}}{[\none, \none, \dots]}} \\
    (\registers'_7, \mathbf{m}) &\equiv \begin{cases}
      (\mathtt{OOB}, \mathbf{m}) &\when \mathbf{p} = \error \\
      (n, \mathbf{m} \cup \{ n \mapsto \tup{\mathbf{p}, \mathbf{u}, i} \} ) &\otherwise \\
    \end{cases} \\
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_P(\gascounter, \registers, \memory, (\mathbf{m}, \mathbf{e}))$ \\
  \texttt{peek} = 21 \\
  $g = 10$} &
  $\begin{aligned}
    \using [n, o, s, z] &= \registers_{7 \dots 11} \\
    \using \mathbf{s} &= \begin{cases}
      \none &\when n \not\in \keys{\mathbf{m}}\\
      (\mathbf{m}[n]_\mathbf{u})_{s\dots+z} &\when \N_{s\dots+z} \subseteq \mathbb{V}_{\mathbf{m}[n]_\mathbf{u}} \wedge \N_{o\dots+z} \subseteq \mathbb{V}^*_\memory \\
      \error &\otherwise
    \end{cases}\\
    (\registers'_7, \mem') &\equiv \begin{cases}
      (\mathtt{OOB}, \mem) &\when \mathbf{s} = \error \\
      (\mathtt{WHO}, \mem) &\when \mathbf{s} = \none \\
      (\mathtt{OK}, \mem') \ \where \mem' = \mem \exc \memwr_{o\dots+z} = \mathbf{s} &\otherwise
    \end{cases} \\
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_O(\gascounter, \registers, \memory, (\mathbf{m}, \mathbf{e}))$ \\
  \texttt{poke} = 22 \\
  $g = 10$} &
  $\begin{aligned}
    \using [n, s, o, z] &= \registers_{7 \dots 11} \\
    \using \mathbf{s} &= \begin{cases}
      \none &\when n \not\in \keys{\mathbf{m}} \\
      \memr_{s\dots+z} &\when \N_{s\dots+z} \subseteq \mathbb{V}_\memory \wedge \N_{o\dots+z} \subseteq \mathbb{V}^*_{\mathbf{m}[n]_\mathbf{u}} \\
      \error &\otherwise
    \end{cases}\\
    (\registers'_7, \mathbf{m}') &\equiv \begin{cases}
      (\mathtt{OOB}, \mathbf{m}) &\when \mathbf{s} = \error \\
      (\mathtt{WHO}, \mathbf{m}) &\when \mathbf{s} = \none \\
      (\mathtt{OK}, \mathbf{m}')\,,\ \where \mathbf{m}' = \mathbf{m} \exc (\mathbf{m}'[n]_\mathbf{u})_{o\dots+z} = \mathbf{s} &\otherwise \\
    \end{cases} \\
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_Z(\gascounter, \registers, \memory, (\mathbf{m}, \mathbf{e}))$ \\
  \texttt{zero} = 23 \\
  $g = 10$} &
  $\begin{aligned}
    \using [n, p, c] &= \registers_{7 \dots 10} \\
    \using \mathbf{u} &= \begin{cases}
      \mathbf{m}[n]_\mathbf{u} &\when n \in \keys{\mathbf{m}} \\
      \error &\otherwise\\
    \end{cases} \\
    \using \mathbf{u}' &= \mathbf{u} \exc \begin{cases}
      (\mathbf{u}'_\mathbf{V})_{p\mathsf{Z}_P\dots+c\mathsf{Z}_P} = [0, 0, \dots] \\
      (\mathbf{u}'_\mathbf{A})_{p\dots+c} = [\mathrm{W}, \mathrm{W}, \dots]
    \end{cases}\\
    (\registers'_7, \mathbf{m}') &\equiv \begin{cases}
      (\mathtt{OOB}, \mathbf{m}) &\when p < 16 \vee p+c \ge \nicefrac{2^{32}}{\mathsf{Z}_P} \\
      (\mathtt{WHO}, \mathbf{m}) &\when \mathbf{u} = \error \\
      (\mathtt{OK}, \mathbf{m}')\,,\ \where \mathbf{m}' = \mathbf{m} \exc \mathbf{m}'[n]_\mathbf{u} = \mathbf{u}' &\otherwise \\
    \end{cases} \\
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_V(\gascounter, \registers, \memory, (\mathbf{m}, \mathbf{e}))$ \\
  \texttt{void} = 24 \\
  $g = 10$} &
  $\begin{aligned}
    \using [n, p, c] &= \registers_{7 \dots 10} \\
    \using \mathbf{u} &= \begin{cases}
      \mathbf{m}[n]_\mathbf{u} &\when n \in \keys{\mathbf{m}} \\
      \error &\otherwise\\
    \end{cases} \\
    \using \mathbf{u}' &= \mathbf{u} \exc \begin{cases}
      (\mathbf{u}'_\mathbf{V})_{p\mathsf{Z}_P\dots+c\mathsf{Z}_P} = [0, 0, \dots] \\
      (\mathbf{u}'_\mathbf{A})_{p\dots+c} = [\none, \none, \dots]
    \end{cases}\\
    (\registers'_7, \mathbf{m}') &\equiv \begin{cases}
      (\mathtt{WHO}, \mathbf{m}) &\when \mathbf{u} = \error \\
      (\mathtt{OOB}, \mathbf{m}) &\when p + c \ge 2^{32} \vee \exists i \in \N_{p\dots+c} : (\mathbf{u}_\mathbf{A})_i = \none \\
      (\mathtt{OK}, \mathbf{m}')\,,\ &\otherwise \\
      \multicolumn{2}{l}{\where \mathbf{m}' = \mathbf{m} \exc \mathbf{m}'[n]_\mathbf{u} = \mathbf{u}'}
    \end{cases} \\
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_K(\gascounter, \registers, \memory, (\mathbf{m}, \mathbf{e}))$ \\
  \texttt{invoke} = 25 \\
  $g = 10$} &
  $\begin{aligned}
    \using [n, o] &= \registers_{7, 8} \\
    \using (g, \mathbf{w}) &= \begin{cases}
      (g, \mathbf{w}): \se_8(g) \concat \joined{\se^\#_8(\mathbf{w})} = \mem_{o \dots+ 112} &\when \N_{o \dots+ 112} \subset \mathbb{V}^*_{\mem} \\
      %(\de_8(\memr_{o\dots+8}), [\de_4(\memr_{o+8+8x\dots+8}) \mid x \orderedin \N_{13}]) &\when \N_{o \dots+ 60} \subset \mathbb{V}^*_{\mem} \\
      (\error, \error) &\otherwise
    \end{cases} \\
    \using (c, i', g', \mathbf{w}', \mathbf{u}') &= \Psi(\mathbf{m}[n]_\mathbf{p}, \mathbf{m}[n]_i, g, \mathbf{w}, \mathbf{m}[n]_\mathbf{u})\\
    \using \mem^* &= \mem \exc \mem^*_{o \dots+ 112} = \se_8(g') \concat \joined{\se_8^\#(\mathbf{w}')}\\
    \using \mathbf{m}^* &= \mathbf{m} \exc \begin{cases}
      \mathbf{m}^*[n]_\mathbf{u} = \mathbf{u}'\\
      \mathbf{m}^*[n]_i = \begin{cases}
        i' + 1 &\when c \in \{ \host \} \times \N_R\\
        i' &\otherwise
      \end{cases}
    \end{cases}\\
    (\registers'_7, \registers'_8, \mem', \mathbf{m}') &\equiv \begin{cases}
      (\mathtt{OOB}, \registers_8, \mem, \mathbf{m}) &\when g = \error \\
      (\mathtt{WHO}, \registers_8, \mem, \mathbf{m}) &\otherwhen n \not\in \mathbf{m} \\
      (\mathtt{HOST}, h, \mem^*, \mathbf{m}^*) &\otherwhen c = \host \times h \\
      (\mathtt{FAULT}, x, \mem^*, \mathbf{m}^*) &\otherwhen c = \fault \times x \\
      (\mathtt{OOG}, \registers_8, \mem^*, \mathbf{m}^*) &\otherwhen c = \oog \\
      (\mathtt{PANIC}, \registers_8, \mem^*, \mathbf{m}^*) &\otherwhen c = \panic \\
      (\mathtt{HALT}, \registers_8, \mem^*, \mathbf{m}^*) &\otherwhen c = \halt \\
    \end{cases} \\
  \end{aligned}$\\
  \cmidrule(lr){1-1}\cmidrule(lr){2-2}
  \makecell*[l]{
  $\Omega_X(\gascounter, \registers, \memory, (\mathbf{m}, \mathbf{e}))$ \\
  \texttt{expunge} = 26 \\
  $g = 10$} &
  $\begin{aligned}
    \using n &= \registers_7 \\
    (\registers'_7, \mathbf{m}') &\equiv \begin{cases}
      (\mathtt{WHO}, \mathbf{m}) &\when n \ne \keys{\mathbf{m}} \\
      (\mathbf{m}[n]_i, \mathbf{m} \setminus n) &\otherwise \\
    \end{cases} \\
  \end{aligned}$\\
  \bottomrule
\end{longtable}
