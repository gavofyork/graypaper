\usepackage{url}
\usepackage{xspace}
\usepackage{graphicx}
\usepackage{multicol,caption}
\usepackage{multirow}
\usepackage{subfig}

\usepackage{mathabx}
\usepackage{mathtools}
\usepackage{mathbbol}
\usepackage{MnSymbol}
\usepackage{bm}
\usepackage{longtable}
\usepackage[hidelinks]{hyperref}
\usepackage[a4paper,width=170mm,top=18mm,bottom=22mm,includeheadfoot]{geometry}
\usepackage{booktabs}
\usepackage{array}
\usepackage{nicefrac}
\usepackage{relsize}
\usepackage{stackengine}
\usepackage{tikz}
\unitlength=1mm
\usetikzlibrary{decorations.markings,calc}
\usepackage{xcolor}
\usepackage{pagecolor}
\usepackage{eso-pic}
\usepackage[math]{cellspace}
\usepackage{makecell}
\usepackage[backend=biber,style=authoryear,autocite=inline]{biblatex}
\usepackage{ifthen}
\usepackage{hyperref}
\usepackage{changepage}

\numberwithin{equation}{section}
\renewcommand{\theequation}{\thesection.\arabic{equation}}

\strictpagecheck
\addbibresource{biblio.bib}

\allowdisplaybreaks

\renewcommand\stacktype{L}
\renewcommand\stackgap{8pt}
\stackMath

\definecolor{verydarkgray}{gray}{0.15}
\definecolor{verylightgray}{gray}{0.85}

\providecommand{\tightlist}{\setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

\makeatletter
\catcode`\¬=11
\newcommand{\superimpose}[2]{{%
  \ooalign{%
    \hfil$\m@th#1\@firstoftwo#2$\hfil\cr
    \hfil$\m@th#1\@secondoftwo#2$\hfil\cr
  }%
}}
\makeatother

\def\drawplusplus#1#2#3{\hbox to 0pt{\hbox to #1{\hfill\vrule height #3 depth
      0pt width #2\hfill\vrule height #3 depth 0pt width #2\hfill
      }}\vbox to #3{\vfill\hrule height #2 depth 0pt width
      #1 \vfill}}
      %Poor man's typography
\def\doubleplus{\mathrel{\drawplusplus {7pt}{0.6pt}{5pt}}}
\def\concat{\ensuremath{\frown}}
\def\seqminusl{\nwspoon}
\def\seqminusr{\sespoon}
\newcommand*\eg{e.g.\@\xspace}
\newcommand*\Eg{E.g.\@\xspace}
\newcommand*\ie{i.e.\@\xspace}
\newcommand*\Ie{I.e.\@\xspace}
\newcommand*\etc{\&c.\@\xspace}
\newcommand*\nb{\textsc{nb}\@\xspace}
\newcommand*\rem{\ \text{\scriptsize{\%}}\ }
\newcommand*\remainder{\text{\hspace{2pt}\footnotesize{\textsf{R}}\hspace{2pt}}}
\newcommand*\fold{\ \thicksim\mathchoice{\!\!\!\!\!\!\!}{\!\!\!\!\!\!}{\!\!\!\!\!\!}{\!\!\!\!\!\!}\int}
\newcommand*{\powset}[2][{}]{\wp\left\langle#2\right\rangle_{#1}}
\newcommand*{\sig}[2]{\mathbb{E}_{#1}\langle#2\rangle}
\newcommand*{\bandersnatch}[3]{\bar{\mathbb{F}}_{#1}^{#3}\langle#2\rangle}
\newcommand*{\bandersig}[3]{\mathbb{F}_{#1}^{#3}\langle#2\rangle}
\newcommand*{\banderout}[1]{\mathcal{Y}(#1)}
\newcommand*{\dict}[2]{\mathbb{D}\langle #1\to#2\rangle}
\newcommand*{\order}[1]{\left[#1\right]}
\newcommand*{\orderby}[2]{\left[#1\,\middle\lwavy\,#2\right]}
\newcommand*{\orderuniqby}[2]{\left[#1\,\middle\lWavy\,#2\right]}
\newcommand*{\token}[1]{\text{{\small \texttt{#1}}}}
\renewcommand*{\H}{\mathbb{H}}
\newcommand*{\N}{\mathbb{N}}
\newcommand*{\Y}{\mathbb{Y}}
\newcommand*{\Z}{\mathbb{Z}}
\newcommand*{\G}{\mathbb{G}}
\newcommand*{\orderedin}{\ensuremath{\mathrel{\mathrlap{<}{\scalebox{0.95}[1]{$-$}}}}}
\newcommand*{\using}{\text{let }}
\newcommand*{\where}{ \text{where }}
\newcommand*{\also}{ \text{and }}
\newcommand*{\otherwise}{\text{otherwise}}
\newcommand*{\otherwhen}{\text{otherwise if }}
\newcommand*{\when}{\text{if }}
\newcommand*{\exc}{\text{ except }}
\newcommand*{\oog}{\infty}
\newcommand*{\error}{\nabla}
\newcommand*{\panic}{\lightning}
\newcommand*{\badexports}{\circledcirc}
\newcommand*{\oversize}{\circleddash}
\newcommand*{\host}{\hbar}
\newcommand*{\halt}{\blacksquare}
\newcommand*{\fault}{\text{\raisebox{6pt}{\rotatebox{180}{\textsf{F}}}}}
\newcommand*{\none}{\emptyset}
\newcommand*{\subifnone}{\mathcal{U}}
\newcommand*{\disjoint}{\downspoon}
\newcommand*{\Jam}{\raisebox{-1.2pt}{J}\textsc{am}\@\xspace}
\newcommand*{\suchthat}{\text{ such that }}
\newcommand*{\keys}[1]{\mathcal{K}(#1)}
\let\originalleft\left
\let\originalright\right
\renewcommand{\left}{\mathopen{}\mathclose\bgroup\originalleft}
\renewcommand{\right}{\aftergroup\egroup\originalright}
\newcommand*{\var}[1]{\left\updownarrow#1\right.\!}
\newcommand*{\maybe}[1]{\mathord{\text{¿}}#1}
\newcommand*{\se}{\mathcal{E}}
\newcommand*{\de}{\mathcal{E}^{-1}}
\newcommand*{\tricolon}{\!\mathrel{\vcenter{\offinterlineskip%
\hbox{\scalebox{0.5}[0.5]{${\scriptscriptstyle \blacktriangleright}$}}
\vskip.15ex
\hbox{\scalebox{0.5}[0.5]{${\scriptscriptstyle \blacktriangleright}$}}
}}}
\newcommand*{\is}[2]{#1\tricolon#2}
\newcommand*{\isa}[2]{#1\in #2}
\newcommand*{\ts}{,\,}
\newcommand*{\lseq}{\left\lsem}
\newcommand*{\rseq}{\right\rsem}
\newcommand*{\ltup}{\!\left\lgroup}
\newcommand*{\rtup}{\right\rgroup\!}
\newcommand*{\ltuple}{\!\left\lgroup}
\newcommand*{\rtuple}{\right\rgroup\!}
\newcommand*{\sq}[1]{\left[#1\right]}
\newcommand*{\seq}[1]{\lseq#1\rseq}
\newcommand*{\tup}[1]{\ltup#1\rtup}
\newcommand*{\tuple}[1]{\ltuple#1\rtuple}
\newcommand*{\floor}[1]{\left\lfloor#1\right\rfloor}
\newcommand*{\ceil}[1]{\left\lceil#1\right\rceil}
\newcommand*{\len}[1]{\left|#1\right|}
\newcommand*{\fnfrac}[2]{\left\lfloor\nicefrac{#1}{#2}\right\rfloor}
\newcommand*{\ffrac}[2]{\left\lfloor\frac{#1}{#2}\right\rfloor}
\newcommand*{\transpose}{{}^\text{T}}
\newcommand*{\joined}{\wideparen}
\newcommand*{\ang}[1]{\langle#1\rangle}
\renewcommand*{\hash}{\mathcal{H}}
\newcommand*{\sub}[1]{_{#1}}

% GP terms
\newcommand*{\goodset}{\psi_\mathbf{g}}
\newcommand*{\badset}{\psi_\mathbf{b}}
\newcommand*{\wonkyset}{\psi_\mathbf{w}}
\newcommand*{\offenders}{\psi_\mathbf{o}}
\newcommand*{\xttickets}{\mathbf{E}_T}
\newcommand*{\xtdisputes}{\mathbf{E}_D}
\newcommand*{\xtassurances}{\mathbf{E}_A}
\newcommand*{\xtpreimages}{\mathbf{E}_P}

% TODO: Use non-prefixed items for common fields:
\newcommand*{\¬gaslimit}{g}
\newcommand*{\¬gasused}{u}
\newcommand*{\¬service}{s}
\newcommand*{\¬payloadhash}{y}
\newcommand*{\¬payload}{\mathbf{y}}
\newcommand*{\¬result}{\mathbf{d}}
\newcommand*{\¬authtrace}{\mathbf{o}}
\newcommand*{\¬core}{c} % O/L ¬codehash
\newcommand*{\¬authorizer}{a} % O/L ¬accgaslimit
\newcommand*{\¬codehash}{h} % O/L \ot¬packagehash
\newcommand*{\¬exportcount}{e}
\newcommand*{\¬importcount}{i}

\newcommand*{\xtguarantees}{\mathbf{E}_G}
\newcommand*{\xg¬workreport}{w}
\newcommand*{\xg¬timeslot}{t}
\newcommand*{\xg¬credential}{a}

\newcommand*{\workpackage}{\mathbb{P}}
\newcommand*{\wp¬authtoken}{\mathbf{j}}
\newcommand*{\wp¬authcodehost}{h}
\newcommand*{\wp¬authcodehash}{u}
\newcommand*{\wp¬authconfig}{\mathbf{p}}
\newcommand*{\wp¬context}{\mathbf{x}} % Consider rename to \mathbf{c}
\newcommand*{\wp¬workitems}{\mathbf{w}}
% derived fields
\newcommand*{\wp¬authorizer}{\¬authorizer}
\newcommand*{\wp¬authcode}{\mathbf{c}}
\newcommand*{\wp¬metadata}{\mathbf{m}}

\newcommand*{\workitem}{\mathbb{I}}
\newcommand*{\wi¬service}{\¬service}
\newcommand*{\wi¬codehash}{\¬codehash}
\newcommand*{\wi¬payload}{\¬payload}
\newcommand*{\wi¬refgaslimit}{g} % O/L ¬gaslimit TODO: use r instead
\newcommand*{\wi¬accgaslimit}{a} % O/L ¬authorizer
\newcommand*{\wi¬exportcount}{\¬exportcount}
\newcommand*{\wi¬importsegments}{\mathbf{i}}
\newcommand*{\wi¬extrinsics}{\mathbf{x}}

\newcommand*{\workreport}{\mathbb{W}}
\newcommand*{\wr¬avspec}{s} % O/L ¬service TODO: make bold
\newcommand*{\wr¬context}{x} % TODO: Make bold like package. Consider renaming to \mathbf{c}
\newcommand*{\wr¬core}{\¬core}
\newcommand*{\wr¬authorizer}{\¬authorizer}
\newcommand*{\wr¬srlookup}{\mathbf{l}}
\newcommand*{\wr¬authtrace}{\¬authtrace} % TODO: Consider renaming to \mathbf{u} to free up \mathbf{o}
\newcommand*{\wr¬digests}{\mathbf{r}} % TODO: Consider renaming to \mathbf{t}/{g} avoid overloading \mathbf{r} reports vs results; maybe \mathbf{t} for results
\newcommand*{\wr¬authgasused}{g}
% TODO: Standardize and fully check this:
% p P: work Packages
% w I: work Items
% w W: work Reports
% r L: work digests TODO: Rename d D
% d: work output data (digest)
% y: work payload

\newcommand*{\workdigest}{\mathbb{L}}
\newcommand*{\wl¬service}{\¬service}
\newcommand*{\wl¬codehash}{\¬codehash}
\newcommand*{\wl¬payloadhash}{\¬payloadhash}
\newcommand*{\wl¬gaslimit}{\¬gaslimit}
\newcommand*{\wl¬result}{\¬result}
\newcommand*{\wl¬gasused}{\¬gasused}
\newcommand*{\wl¬importcount}{\¬importcount}
\newcommand*{\wl¬xtcount}{x}
\newcommand*{\wl¬xtsize}{z}
\newcommand*{\wl¬exportcount}{\¬exportcount}

\newcommand*{\operandtuple}{\mathbb{O}}
\newcommand*{\ot¬packagehash}{h} % O/L ¬codehash TODO: RENAME to k
\newcommand*{\ot¬segroot}{e} % O/L ¬exportcount TODO: RENAME to r?
\newcommand*{\ot¬authorizer}{\¬authorizer}
\newcommand*{\ot¬authtrace}{\¬authtrace}
\newcommand*{\ot¬payloadhash}{\¬payloadhash}
\newcommand*{\ot¬gaslimit}{\¬gaslimit}
\newcommand*{\ot¬result}{\¬result}

\newcommand*{\avspec}{\mathbb{S}}
\newcommand*{\as¬packagehash}{h}
\newcommand*{\as¬bundlelen}{l}
\newcommand*{\as¬erasureroot}{u}
\newcommand*{\as¬segroot}{r} % Inconsistent with other segroot. TODO: RENAME to e?
\newcommand*{\as¬segcount}{n}

\newcommand*{\serviceaccount}{\mathbb{A}}
\newcommand*{\sa¬storage}{\mathbf{s}}
\newcommand*{\sa¬preimages}{\mathbf{p}}
\newcommand*{\sa¬requests}{\mathbf{l}}
\newcommand*{\sa¬gratis}{f}
\newcommand*{\sa¬minaccgas}{g}
\newcommand*{\sa¬minmemogas}{m}
\newcommand*{\sa¬codehash}{c} % Inconsistent with ¬codehash
\newcommand*{\sa¬balance}{b}
\newcommand*{\sa¬created}{r}
\newcommand*{\sa¬lastacc}{a}
\newcommand*{\sa¬parent}{p}
% Derived fields
\newcommand*{\sa¬items}{i}
\newcommand*{\sa¬octets}{o}
\newcommand*{\sa¬minbalance}{f}

% MISC - These need tidying.
\newcommand*{\vk¬ed}{e}

\newcommand*{\partialstate}{\mathbb{U}}
\newcommand*{\defxfer}{\mathbb{T}}
\newcommand*{\defxfers}{\seq{\defxfer}}

\newcommand*{\privileges}{\chi}
\newcommand*{\manager}{\privileges_m}
\newcommand*{\delegator}{\privileges_v}
\newcommand*{\assigners}{\privileges_\mathbf{a}}
\newcommand*{\alwaysaccers}{\privileges_\mathbf{g}}
\newcommand*{\accumulated}{\xi}
\newcommand*{\ready}{\vartheta}
\newcommand*{\lastaccout}{\theta}
\newcommand*{\authpool}{\alpha}
\newcommand*{\recenthistory}{\beta_H}
\newcommand*{\beefybelt}{\beta_B}

\newcommand*{\accountspre}{\delta}
\newcommand*{\accountspostacc}{\delta^\dagger}
\newcommand*{\accountspostxfer}{\delta^\ddagger}
\newcommand*{\accountspostpreimage}{\delta'}

% PVM stuff
\newcommand*{\gascounter}{\varrho}
\newcommand*{\registers}{\omega}
\newcommand*{\memory}{\mu}

\newcommand*{\jamdraftversion}{\input{VERSION}\!\!\!\!}
\newcommand*{\jamdraftversionstring}{\jamdraftversion}

\newcommand*{\makegpbackground}{
  \AddToShipoutPicture{
    \checkoddpage
    \ifoddpage
        \put(-1 mm,0){\includegraphics[width=\paperwidth,height=\paperheight]{assets/grayr.png}}
    \else
        \put(-1 mm,0){\includegraphics[width=\paperwidth,height=\paperheight]{assets/grayl.png}}
    \fi
  }
}
\input{context.tex}

\title[JAM: Join-Accumulate Machine \\ {\smaller \textbf{Draft \jamdraftversionstring\ -\ \today}}]{Join-Accumulate Machine: A Mostly-Coherent Trustless Supercomputer \\ {\smaller Draft \jamdraftversionstring\ -\ \today}}
\author{
  Dr. Gavin Wood\\
  Founder, Polkadot \& Ethereum\\%, Parity, Web3 Foundation, Fellowship\\
   gavin@parity.io }
